<% layout('layout') %>

<style>
  /* Premium Professional Design */
  .token-usage-card {
    background: linear-gradient(135deg, rgba(22, 27, 34, 0.9) 0%, rgba(13, 17, 23, 0.95) 100%);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(88, 166, 255, 0.1);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.03) inset;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .token-usage-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(88, 166, 255, 0.05) 0%, transparent 70%);
    pointer-events: none;
  }
  
  .token-usage-card:hover {
    border-color: rgba(88, 166, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 12px 48px rgba(88, 166, 255, 0.15), 0 0 0 1px rgba(88, 166, 255, 0.1) inset;
  }
  .usage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    position: relative;
    z-index: 1;
  }
  .usage-title {
    font-size: 18px;
    font-weight: 700;
    background: linear-gradient(135deg, #c9d1d9 0%, #8b949e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
  }
  .subscription-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  .sub-free {
    background: #6e7681;
    color: #f0f6fc;
  }
  .sub-pro {
    background: #238636;
    color: #aff5b4;
  }
  .sub-enterprise {
    background: #1f6feb;
    color: #a5d6ff;
  }
  .usage-progress {
    height: 10px;
    background: rgba(33, 38, 45, 0.6);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 1;
  }
  .usage-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #238636 0%, #2ea043 100%);
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s ease;
    box-shadow: 0 0 12px rgba(35, 134, 54, 0.5);
    position: relative;
  }
  
  .usage-progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: shimmer 2s infinite;
  }
  
  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  .usage-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-top: 12px;
  }
  .usage-stat {
    text-align: center;
  }
  .usage-stat-value {
    font-size: 20px;
    font-weight: 700;
    color: #c9d1d9;
  }
  .usage-stat-label {
    font-size: 11px;
    color: #8b949e;
    text-transform: uppercase;
    margin-top: 4px;
  }
  .upgrade-message {
    display: none;
    background: #9a6700;
    color: #f0e6b9;
    padding: 12px;
    border-radius: 6px;
    margin-top: 12px;
    font-size: 13px;
  }
  .upgrade-message a {
    color: #f0e6b9;
    text-decoration: underline;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 24px;
    margin-bottom: 40px;
  }
  .stat-card {
    background: linear-gradient(135deg, rgba(22, 27, 34, 0.8) 0%, rgba(13, 17, 23, 0.9) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(88, 166, 255, 0.1);
    border-radius: 16px;
    padding: 28px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
  }
  
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #58a6ff 0%, #1f6feb 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  
  .stat-card:hover::before {
    opacity: 1;
  }
  
  .stat-card:hover { 
    border-color: rgba(88, 166, 255, 0.4);
    box-shadow: 0 8px 40px rgba(88, 166, 255, 0.2), 0 0 0 1px rgba(88, 166, 255, 0.1) inset;
  }
  .stat-card.clickable {
    cursor: pointer;
  }
  .stat-card.clickable:hover {
    transform: translateY(-6px);
  }
  .stat-label {
    color: #8b949e;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .stat-value {
    font-size: 42px;
    font-weight: 900;
    color: #c9d1d9;
    margin-bottom: 8px;
    letter-spacing: -0.03em;
    line-height: 1;
  }
  .stat-desc {
    font-size: 13px;
    color: #6e7681;
    line-height: 1.5;
  }
  
  .section {
    background: linear-gradient(135deg, rgba(22, 27, 34, 0.8) 0%, rgba(13, 17, 23, 0.9) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(88, 166, 255, 0.1);
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 32px;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }
  
  .section:hover {
    border-color: rgba(88, 166, 255, 0.2);
  }
  
  .section-title {
    font-size: 20px;
    font-weight: 700;
    background: linear-gradient(135deg, #c9d1d9 0%, #8b949e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 28px;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .activity-item {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 20px 16px;
    border-bottom: 1px solid rgba(33, 38, 45, 0.5);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    border-radius: 12px;
    margin-bottom: 4px;
  }
  .activity-item:last-child { border-bottom: none; }
  .activity-item:hover { 
    background: rgba(88, 166, 255, 0.05);
    transform: translateX(4px);
    border-color: rgba(88, 166, 255, 0.2);
  }
  .activity-details {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 6px;
  }
  .activity-detail-row {
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: #8b949e;
  }
  .detail-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .badge {
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }
  .badge-success { background: #1a7f37; color: #aff5b4; }
  .badge-warning { background: #9a6700; color: #f0e6b9; }
  .badge-danger { background: #a40e26; color: #ffdce0; }
  .badge-info { background: #0969da; color: #a5d6ff; }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 16px;
    flex-shrink: 0;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.1);
  }
  .status-queued { 
    background: linear-gradient(135deg, #848d97 0%, #6e7681 100%);
  }
  .status-running { 
    background: linear-gradient(135deg, #1f6feb 0%, #0969da 100%);
    animation: pulse-glow 2s infinite;
    box-shadow: 0 0 20px rgba(31, 111, 235, 0.6);
  }
  .status-completed { 
    background: linear-gradient(135deg, #238636 0%, #1a7f37 100%);
    box-shadow: 0 0 16px rgba(35, 134, 54, 0.4);
  }
  .status-failed { 
    background: linear-gradient(135deg, #da3633 0%, #a40e26 100%);
    box-shadow: 0 0 16px rgba(218, 54, 51, 0.4);
  }
  
  @keyframes pulse-glow {
    0%, 100% { 
      opacity: 1;
      box-shadow: 0 0 20px rgba(31, 111, 235, 0.6);
    }
    50% { 
      opacity: 0.8;
      box-shadow: 0 0 30px rgba(31, 111, 235, 0.9);
    }
  }
  
  .activity-content {
    flex: 1;
    min-width: 0;
  }
  .activity-title {
    font-size: 14px;
    font-weight: 500;
    color: #c9d1d9;
    margin-bottom: 2px;
  }
  .activity-meta {
    font-size: 12px;
    color: #6e7681;
  }
  
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #6e7681;
  }
  .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
</style>

<!-- Premium Page Header -->
<div style="margin-bottom: 48px; position: relative;">
  <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
    <div style="width: 4px; height: 48px; background: linear-gradient(180deg, #58a6ff 0%, #1f6feb 100%); border-radius: 4px; box-shadow: 0 0 20px rgba(88, 166, 255, 0.5);"></div>
    <h1 style="font-size: 36px; font-weight: 900; background: linear-gradient(135deg, #58a6ff 0%, #79c0ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -0.03em; margin: 0;">Dashboard</h1>
  </div>
  <p style="color: #8b949e; font-size: 15px; margin-left: 20px; line-height: 1.6;">Monitor your code review activities and AI-powered fixes in real-time</p>
</div>

<!-- Token Usage Widget -->
<div class="token-usage-card">
  <div class="usage-header">
    <div class="usage-title">🎯 Your Token Usage</div>
    <div style="display: flex; align-items: center; gap: 8px;">
      <span id="token-source-badge" class="subscription-badge" style="background: #6e7681; color: #f0f6fc; font-size: 10px;">PLATFORM</span>
      <span id="subscription-badge" class="subscription-badge sub-free">FREE</span>
    </div>
  </div>
  <div id="usage-progress" class="usage-progress">
    <div id="usage-progress-fill" class="usage-progress-fill" style="width: 0%;"></div>
  </div>
  <div style="text-align: center; margin-bottom: 8px;">
    <span id="usage-progress-text" style="font-size: 14px; font-weight: 600; color: #c9d1d9;">0%</span>
  </div>
  <div class="usage-stats">
    <div class="usage-stat">
      <div class="usage-stat-value" id="user-tokens-used">0</div>
      <div class="usage-stat-label">Tokens Used</div>
    </div>
    <div class="usage-stat">
      <div class="usage-stat-value" id="user-tokens-remaining">1,000</div>
      <div class="usage-stat-label">Remaining</div>
    </div>
    <div class="usage-stat">
      <div class="usage-stat-value" id="user-token-limit">1,000</div>
      <div class="usage-stat-label">Total Limit</div>
    </div>
  </div>
  <div id="upgrade-message" class="upgrade-message">
    ⚠️ You're running low on tokens! <a href="/settings/api-keys">Add your API keys</a> or <a href="/settings/subscription">upgrade your plan</a> to continue.
  </div>
</div>

<!-- Premium Stats Summary Banner -->
<div style="background: linear-gradient(135deg, rgba(22, 27, 34, 0.8) 0%, rgba(13, 17, 23, 0.9) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(88, 166, 255, 0.15); border-radius: 20px; padding: 32px 36px; margin-bottom: 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.03) inset; position: relative; overflow: hidden;">
  <div style="position: absolute; top: -50%; right: -20%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(88, 166, 255, 0.08) 0%, transparent 70%); pointer-events: none;"></div>
  <div style="position: relative; z-index: 1;">
    <div style="font-size: 12px; color: #8b949e; margin-bottom: 6px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;">⏱️ Last Updated</div>
    <div style="font-size: 15px; color: #c9d1d9; font-weight: 600;"><%= new Date().toLocaleString() %></div>
  </div>
  <div style="display: flex; gap: 40px; position: relative; z-index: 1;">
    <div style="text-align: center;">
      <div style="font-size: 10px; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px;">Total PRs</div>
      <div style="font-size: 32px; font-weight: 900; background: linear-gradient(135deg, #c9d1d9 0%, #8b949e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -0.02em;"><%= stats.totalRuns %></div>
    </div>
    <div style="width: 1px; background: linear-gradient(180deg, transparent 0%, rgba(88, 166, 255, 0.2) 50%, transparent 100%);"></div>
    <div style="text-align: center;">
      <div style="font-size: 10px; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px;">Issues Found</div>
      <div style="font-size: 32px; font-weight: 900; background: linear-gradient(135deg, #f0883e 0%, #d97706 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -0.02em;"><%= stats.totalIssues %></div>
    </div>
    <div style="width: 1px; background: linear-gradient(180deg, transparent 0%, rgba(88, 166, 255, 0.2) 50%, transparent 100%);"></div>
    <div style="text-align: center;">
      <div style="font-size: 10px; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px;">Issues Fixed</div>
      <div style="font-size: 32px; font-weight: 900; background: linear-gradient(135deg, #3fb950 0%, #2ea043 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -0.02em;"><%= stats.fixedIssues %></div>
    </div>
    <div style="width: 1px; background: linear-gradient(180deg, transparent 0%, rgba(88, 166, 255, 0.2) 50%, transparent 100%);"></div>
    <div style="text-align: center;">
      <div style="font-size: 10px; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px;">Fix Rate</div>
      <div style="font-size: 32px; font-weight: 900; background: linear-gradient(135deg, #58a6ff 0%, #1f6feb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -0.02em;"><%= stats.totalIssues > 0 ? Math.round(stats.fixedIssues / stats.totalIssues * 100) : 0 %>%</div>
    </div>
  </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
  <a href="/repos" style="text-decoration: none; color: inherit;">
    <div class="stat-card clickable">
      <div class="stat-label">📊 Total PRs Analyzed</div>
      <div class="stat-value"><%= stats.totalRuns %></div>
      <div class="stat-desc"><%= stats.completedRuns %> completed successfully</div>
    </div>
  </a>
  <div class="stat-card">
    <div class="stat-label">🔍 Issues Found</div>
    <div class="stat-value" style="color: #f0883e;"><%= stats.totalIssues %></div>
    <div class="stat-desc">Detected across all repositories</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">✅ Issues Fixed</div>
    <div class="stat-value" style="color: #3fb950;"><%= stats.fixedIssues %></div>
    <div class="stat-desc"><%= stats.totalIssues > 0 ? Math.round(stats.fixedIssues / stats.totalIssues * 100) : 0 %>% of all issues resolved</div>
  </div>
  <a href="/installations" style="text-decoration: none; color: inherit;">
    <div class="stat-card clickable">
      <div class="stat-label">🔗 Connected Repos</div>
      <div class="stat-value"><%= stats.totalConnectedRepos %></div>
      <div class="stat-desc">Repositories with Peer installed</div>
    </div>
  </a>
</div>

<!-- Repository Stats Table -->
<% if (repoStats && repoStats.length > 0) { %>
<div class="section">
  <div class="section-title">📦 Repository Statistics</div>
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 1px solid #30363d;">
          <th style="text-align: left; padding: 12px 8px; color: #8b949e; font-size: 13px; font-weight: 600;">Repository</th>
          <th style="text-align: center; padding: 12px 8px; color: #8b949e; font-size: 13px; font-weight: 600;">Total PRs</th>
          <th style="text-align: center; padding: 12px 8px; color: #8b949e; font-size: 13px; font-weight: 600;">Completed</th>
          <th style="text-align: center; padding: 12px 8px; color: #8b949e; font-size: 13px; font-weight: 600;">Issues Found</th>
          <th style="text-align: center; padding: 12px 8px; color: #8b949e; font-size: 13px; font-weight: 600;">Issues Fixed</th>
          <th style="text-align: center; padding: 12px 8px; color: #8b949e; font-size: 13px; font-weight: 600;">Fix Rate</th>
          <th style="text-align: center; padding: 12px 8px; color: #8b949e; font-size: 13px; font-weight: 600;">Success Rate</th>
        </tr>
      </thead>
      <tbody>
        <% repoStats.forEach((repo, idx) => { %>
        <tr style="border-bottom: 1px solid #21262d; <%= idx % 2 === 0 ? 'background: #0d1117;' : '' %>">
          <td style="padding: 12px 8px; color: #c9d1d9; font-size: 14px; font-family: ui-monospace, monospace;"><%= repo.repo %></td>
          <td style="text-align: center; padding: 12px 8px; color: #c9d1d9; font-size: 14px;"><%= repo.totalPRs %></td>
          <td style="text-align: center; padding: 12px 8px; color: #c9d1d9; font-size: 14px;"><%= repo.completedPRs %></td>
          <td style="text-align: center; padding: 12px 8px; color: #c9d1d9; font-size: 14px;"><%= repo.totalIssues %></td>
          <td style="text-align: center; padding: 12px 8px; font-size: 14px;">
            <span style="<%= repo.fixedIssues > 0 ? 'color: #3fb950;' : 'color: #c9d1d9;' %>"><%= repo.fixedIssues %></span>
          </td>
          <td style="text-align: center; padding: 12px 8px; font-size: 14px;">
            <span style="padding: 4px 8px; border-radius: 12px; font-weight: 500; <%= repo.fixRate >= 75 ? 'background: #1a7f37; color: #aff5b4;' : repo.fixRate >= 50 ? 'background: #9a6700; color: #f0e6b9;' : repo.fixRate >= 25 ? 'background: #9a6700; color: #f0e6b9;' : 'background: #a40e26; color: #ffdce0;' %>"><%= repo.fixRate %>%</span>
          </td>
          <td style="text-align: center; padding: 12px 8px; font-size: 14px;">
            <span style="padding: 4px 8px; border-radius: 12px; font-weight: 500; <%= repo.successRate >= 75 ? 'background: #1a7f37; color: #aff5b4;' : repo.successRate >= 50 ? 'background: #9a6700; color: #f0e6b9;' : repo.successRate >= 25 ? 'background: #9a6700; color: #f0e6b9;' : 'background: #a40e26; color: #ffdce0;' %>"><%= repo.successRate %>%</span>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>
<% } %>

<!-- Recent Activity -->
<div class="section">
  <div class="section-title">📊 Recent Activity</div>
  <% if (recentRuns && recentRuns.length > 0) { %>
    <% recentRuns.forEach(run => { 
      const findings = run.findings || [];
      const fixedCount = findings.filter(f => f.fixed).length;
      const criticalCount = findings.filter(f => f.severity === 'critical').length;
      const highCount = findings.filter(f => f.severity === 'high').length;
      const mediumCount = findings.filter(f => f.severity === 'medium').length;
      const lowCount = findings.filter(f => f.severity === 'low').length;
      const fixRate = findings.length > 0 ? Math.round((fixedCount / findings.length) * 100) : 0;
    %>
      <a href="/pr/<%= run._id %>" class="activity-item" style="display: flex;">
        <span class="status-badge status-<%= run.status %>">
          <%= run.status === 'completed' ? '✓' : run.status === 'failed' ? '✗' : run.status === 'running' ? '⟳' : '○' %>
        </span>
        <div class="activity-content">
          <div class="activity-title">
            📦 <%= run.repo %> #<%= run.prNumber %>
          </div>
          <div class="activity-meta" style="margin-bottom: 8px;">
            <strong style="color: #c9d1d9;"><%= run.status.toUpperCase() %></strong> • 
            🕰️ <%= new Date(run.createdAt).toLocaleString() %>
            <% if (run.installationMode) { %>
              <% 
                const modeLabels = {
                  'analyze': { text: 'Analyze Only', color: '#6e7681' },
                  'commit': { text: 'Auto-Commit', color: '#1f6feb' },
                  'merge': { text: 'Auto-Merge', color: '#238636' },
                  'review': { text: 'Manual Review', color: '#9a6700' }
                };
                const modeInfo = modeLabels[run.installationMode] || { text: run.installationMode, color: '#6e7681' };
              %>
              • <span class="badge" style="background: <%= modeInfo.color %>; color: #f0f6fc;"><%= modeInfo.text %></span>
            <% } %>
          </div>
          <div class="activity-details">
            <div class="activity-detail-row">
              <div class="detail-item">
                <span>🔍 Total Issues:</span>
                <strong style="color: #c9d1d9;"><%= findings.length %></strong>
              </div>
              <div class="detail-item">
                <span>✅ Fixed:</span>
                <strong style="color: #3fb950;"><%= fixedCount %></strong>
                <% if (findings.length > 0) { %>
                  <span class="badge <%= fixRate >= 75 ? 'badge-success' : fixRate >= 50 ? 'badge-warning' : 'badge-danger' %>"><%= fixRate %>%</span>
                <% } %>
              </div>
            </div>
            <% if (findings.length > 0) { %>
            <div class="activity-detail-row">
              <div class="detail-item">
                <span>Severity:</span>
                <% if (criticalCount > 0) { %><span class="badge badge-danger">🔴 <%= criticalCount %> Critical</span><% } %>
                <% if (highCount > 0) { %><span class="badge badge-warning">🟠 <%= highCount %> High</span><% } %>
                <% if (mediumCount > 0) { %><span class="badge badge-info">🟡 <%= mediumCount %> Medium</span><% } %>
                <% if (lowCount > 0) { %><span class="badge" style="background: #6e7681; color: #c9d1d9;">⚪ <%= lowCount %> Low</span><% } %>
              </div>
            </div>
            <% } %>
            <% if (run.sha) { %>
            <div class="activity-detail-row">
              <div class="detail-item">
                <span>📦 Commit:</span>
                <code style="font-size: 11px; color: #58a6ff;"><%= run.sha.substring(0, 7) %></code>
              </div>
            </div>
            <% } %>
          </div>
        </div>
      </a>
    <% }) %>
  <% } else { %>
    <div class="empty-state">
      <div class="empty-state-icon">📭</div>
      <p>No PR runs yet. Connect a repository to get started!</p>
    </div>
  <% } %>
</div>


<script>
  // Fetch and display user token usage
  async function refreshUserUsage() {
    try {
      const res = await fetch('/api/user/usage');
      const data = await res.json();
      
      if (data.ok) {
        document.getElementById('user-tokens-used').textContent = data.tokensUsed.toLocaleString();
        document.getElementById('user-token-limit').textContent = data.unlimited ? 'Unlimited' : data.tokenLimit.toLocaleString();
        document.getElementById('user-tokens-remaining').textContent = data.unlimited ? 'Unlimited' : data.remaining.toLocaleString();
        
        // Update progress bar
        const progressBar = document.getElementById('usage-progress');
        const progressFill = document.getElementById('usage-progress-fill');
        const progressText = document.getElementById('usage-progress-text');
        
        if (progressBar && progressFill && progressText) {
          if (data.unlimited) {
            progressFill.style.width = '0%';
            progressFill.style.background = '#238636';
            progressText.textContent = 'Unlimited';
          } else {
            const percentage = data.percentage;
            progressFill.style.width = percentage + '%';
            
            // Color based on usage
            if (percentage >= 90) {
              progressFill.style.background = '#da3633';
            } else if (percentage >= 75) {
              progressFill.style.background = '#f0883e';
            } else {
              progressFill.style.background = '#238636';
            }
            
            progressText.textContent = percentage + '%';
          }
        }
        
        // Update subscription badge
        const subBadge = document.getElementById('subscription-badge');
        if (subBadge) {
          subBadge.textContent = data.subscriptionTier.toUpperCase();
          subBadge.className = 'subscription-badge ' + (data.subscriptionTier === 'free' ? 'sub-free' : data.subscriptionTier === 'pro' ? 'sub-pro' : 'sub-enterprise');
        }
        
        // Update token source badge
        const tokenSourceBadge = document.getElementById('token-source-badge');
        if (tokenSourceBadge) {
          if (data.hasOwnKeys) {
            tokenSourceBadge.textContent = 'YOUR API KEYS';
            tokenSourceBadge.style.background = '#238636';
            tokenSourceBadge.style.color = '#aff5b4';
          } else {
            tokenSourceBadge.textContent = 'PLATFORM TOKENS';
            tokenSourceBadge.style.background = '#6e7681';
            tokenSourceBadge.style.color = '#f0f6fc';
          }
        }
        
        // Show/hide upgrade message
        const upgradeMsg = document.getElementById('upgrade-message');
        if (upgradeMsg) {
          if (data.percentage >= 90 && !data.hasOwnKeys && !data.unlimited) {
            upgradeMsg.style.display = 'block';
          } else {
            upgradeMsg.style.display = 'none';
          }
        }
      }
    } catch (error) {
      console.error('Failed to fetch user usage:', error);
    }
  }
  
  // Load user usage on page load
  window.addEventListener('load', refreshUserUsage);
</script>
